rules_version = '2';

/**
 * Step 5 Security Rules: Multi-Tenant Isolation
 *
 * This ruleset enforces strict multi-tenant isolation while allowing
 * controlled public access for booking and status pages.
 *
 * IMPORTANT: Single Doctor Model - Each clinic has exactly ONE doctor (the owner).
 *
 * Key Security Principles:
 * 1. Default deny all access
 * 2. Public can GET (not list) specific active resources
 * 3. Staff can only access their own clinic's data
 * 4. Public can CREATE booking tickets (with strict validation)
 *    - Alternative: Use server API /api/public/book for additional security
 * 5. Anti-scraping: no list queries on public collections
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for multi-tenant isolation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserClinicId() {
      return get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data.clinicId;
    }
    
    function getNurseClinicId() {
      return get(/databases/$(database)/documents/nurses/$(request.auth.uid)).data.clinicId;
    }
    
    function isActiveDoctor() {
      return exists(/databases/$(database)/documents/doctors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data.isActive == true;
    }
    
    function isActiveNurse() {
      return exists(/databases/$(database)/documents/nurses/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/nurses/$(request.auth.uid)).data.isActive == true;
    }
    
    function sameClinic(clinicId) {
      return isAuthenticated() && (
        (isActiveDoctor() && getUserClinicId() == clinicId) ||
        (isActiveNurse() && getNurseClinicId() == clinicId) ||
        (exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.clinicId == clinicId &&
         get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.isActive == true)
      );
    }
    
    function isDoctor() {
      return isAuthenticated() && exists(/databases/$(database)/documents/doctors/$(request.auth.uid));
    }
    
    function isNurse() {
      return isAuthenticated() && exists(/databases/$(database)/documents/nurses/$(request.auth.uid));
    }

    // ==========================================================================
    // DEFAULT DENY ALL
    // ==========================================================================
    match /{document=**} {
      allow read, write: if false;
    }

    // ==========================================================================
    // PUBLIC COLLECTIONS (Get-only, no list queries)
    // ==========================================================================
    
    // Legacy Clinic Info: Support for old settings
    match /clinicInfo/{docId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // Clinics: Public can get active clinics by ID
    match /clinics/{clinicId} {
      // Public: Can get (read single) active clinics by ID
      allow get: if resource.data.isActive == true;
      
      // Public: Can list active clinics only (for clinic selection page)
      // Limited to 50 results to prevent excessive scraping
      allow list: if request.query.limit <= 50;
      
      // Staff: Can read/write their own clinic (includes list for admin pages)
      allow read, write: if sameClinic(clinicId);
      
      // Invites subcollection: Only staff can manage
      match /invites/{inviteId} {
        // Public: Can read pending invites (for accept-invite page)
        // Token verification happens in client code
        allow get: if resource.data.status == 'pending';
        
        // Staff: Can read/update/delete invites for their clinic
        allow get, list, update, delete: if sameClinic(clinicId);
        
        // Staff: Can create invites for their clinic
        allow create: if sameClinic(clinicId);
      }
    }
    
    // Doctors: Public can get active doctors by ID
    // NOTE: Single doctor model - each clinic has ONE doctor (the owner, doctorId = ownerUid)
    match /doctors/{doctorId} {
      // Doctor: Can read/write their own profile (even if deactivated, to show error message)
      allow read, write: if isAuthenticated() && request.auth.uid == doctorId;
      
      // Public: Can ONLY get (not list) active doctors by ID
      // This prevents scraping of all doctors
      allow get: if resource.data.isActive == true;
      
      // New doctor: Can create their own profile (for invite acceptance)
      allow create: if isAuthenticated() && 
        request.auth.uid == doctorId &&
        request.resource.data.uid == request.auth.uid;
      
      // Same clinic staff: Can read
      allow read: if (resource.data.get('clinicId', null) != null && sameClinic(resource.data.clinicId)) ||
                   (resource.data.get('clinicId', null) == null && isAuthenticated());
    }
    
    // Nurses: Only staff can access
    match /nurses/{nurseId} {
      // Nurse: Can read/write their own profile (even if deactivated, to show error message)
      allow read, write: if isAuthenticated() && request.auth.uid == nurseId;
      
      // New nurse: Can create their own profile (for invite acceptance)
      allow create: if isAuthenticated() && 
        request.auth.uid == nurseId &&
        request.resource.data.uid == request.auth.uid;
      
      // Same clinic staff: Can read (only active staff)
      allow read: if (resource.data.get('clinicId', null) != null && sameClinic(resource.data.clinicId)) ||
                   (resource.data.get('clinicId', null) == null && isAuthenticated());
    }
    
    // Booking Tickets: Public can get individual tickets (privacy-safe status page)
    match /bookingTickets/{ticketId} {
      // Public: Can get ticket if not expired (24 hours)
      allow get: if resource.data.expiresAt.toMillis() > request.time.toMillis();
      
      // Public: Can create booking tickets with validation
      // Security: validate required fields, prevent data injection
      allow create: if 
        // Required fields exist and are valid
        request.resource.data.clinicId is string &&
        request.resource.data.doctorId is string &&
        request.resource.data.patientId is string &&
        request.resource.data.displayName is string &&
        request.resource.data.phoneLast4 is string &&
        request.resource.data.status in ['Waiting', 'Consulting', 'Finished'] &&
        request.resource.data.queueType in ['Consultation', 'Re-consultation'] &&
        // Timestamps are valid
        request.resource.data.createdAt is timestamp &&
        request.resource.data.expiresAt is timestamp &&
        request.resource.data.expiresAt.toMillis() > request.time.toMillis() &&
        // Prevent future-dated createdAt (anti-cheating)
        request.resource.data.createdAt.toMillis() <= request.time.toMillis() + 60000;
      
      // Staff: Can read tickets for their clinic
      allow read: if sameClinic(resource.data.clinicId);
      
      // Staff: Can create/update tickets for their clinic
      allow create: if sameClinic(request.resource.data.clinicId);
      allow update: if sameClinic(resource.data.clinicId);
    }
    
    // Queue State: Public can get current queue state (anti-scraping)
    match /queueState/{stateId} {
      // Public: Can get queue state (format: {clinicId}_{doctorId})
      allow get: if true;
      
      // Public: CANNOT list all queue states (anti-scraping)
      // Use server API /api/public/queue-count instead
      
      // Staff: Can read for their clinic
      allow read: if sameClinic(resource.data.clinicId);
      
      // Staff: Can create/update queue state for their clinic
      allow create: if sameClinic(request.resource.data.clinicId);
      allow update: if sameClinic(resource.data.clinicId);
    }

    // ==========================================================================
    // STAFF-ONLY COLLECTIONS (Multi-tenant isolation)
    // ==========================================================================
    
    // Patients: Strict multi-tenant isolation
    match /patients/{patientId} {
      // Staff: Can read/update/delete patients from their clinic
      allow read, update, delete: if 
        (resource.data.get('clinicId', null) != null && sameClinic(resource.data.clinicId)) ||
        (resource.data.get('clinicId', null) == null && isAuthenticated());
      
      // Staff: Can create patients for their clinic
      allow create: if 
        (request.resource.data.get('clinicId', null) != null && sameClinic(request.resource.data.clinicId)) ||
        (request.resource.data.get('clinicId', null) == null && isAuthenticated());
    }
    
    // User Profiles: Users can only access their own profile
    match /userProfiles/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ==========================================================================
    // DOCTOR MESSAGES (Notifications for nurses and patients)
    // ==========================================================================
    
    // Doctor Messages: Public can read latest message, staff can manage
    match /doctorMessages/{messageId} {
      // Public: Can read messages (for patient status page)
      allow get, list: if true;
      
      // Staff: Can create messages for their clinic
      allow create: if isAuthenticated() && sameClinic(request.resource.data.clinicId);
      
      // Staff: Can update/delete messages from their clinic
      allow update, delete: if isAuthenticated() && sameClinic(resource.data.clinicId);
    }

    // ==========================================================================
    // PLATFORM ADMIN COLLECTIONS (Server-side only, no client access)
    // ==========================================================================
    
    // Platform Admins: No client access (Admin SDK only)
    match /platformAdmins/{adminId} {
      // Users can ONLY read their own admin status (for UI decisions)
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      
      // No writes from client (Admin SDK only)
      allow write: if false;
    }
    
    // Platform Clients: No client access (Admin SDK only)
    match /platformClients/{clientId} {
      // Completely deny all client access - must use /api/platform/* routes
      allow read, write: if false;
    }
  }
}
